---
layout: post
title: Varnish State Machine
image: /assets/images/covers/varnish_2.png
tags: [varnish, highload]
show_on_main: 1
keywords: varnish, highload, varnish state machine, vcl
description: Varnish State Machine — конечный автомат, описывающий процесс обработки каждого приходящего запроса.
---

<p>
    <strong>Varnish State Machine</strong> — конечный автомат, описывающий процесс обработки каждого приходящего
    запроса.
</p>
<p>
    В упрощенном варианте обработка запроса проходит как показано на диаграмме, приведенной ниже:
</p>

<img class="img-responsive" alt="Varnish simple flow" title="Varnish simple flow"
     src="https://docs.google.com/drawings/d/12YykcOea1XUd0eqP_wt54A-hfAFhPKl_MlnAWKHt7_g/pub?w=1215&amp;h=601">

<p>
    Сама стейт-машина Varnish выглядит примерно следующим образом (постепенно дорабатывается):
</p>

<div class="mxgraph" style="position:relative;overflow:hidden;width:100%;">
    <div style="width:1px;height:1px;overflow:hidden;">
        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
    </div>
</div>

<p><strong>Полезные ссылки:</strong></p> 
<p>
    <ul>
        <li>
            <a href="https://www.varnish-software.com/static/book/VCL_Basics.html">Схема от Varnish</a> - 
            к сожалению на данный момент не актуальная т.к. неокторые функции, например, vcl_fetch разбились, 
            либо переименовались. 
        </li>
        <li><a href="https://www.varnish-cache.org/docs/trunk/reference/states.html">Varnish Processing States</a> - 
            визуально сложно воспринять с первого подхода.</li>
        <li><a href="http://www.emanuelis.eu/2014/09/25/varnish-4-vcl-request-flow/">Varnish Flow от Emanuelis</a> - более актуальная схема чем на сайте Varnish</li>
    </ul>
</p>

<script type="text/javascript" src="https://www.draw.io/js/embed-static.min.js"></script>